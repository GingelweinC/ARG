<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sudoku CRT - Dossier 04</title>
  <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
  <style>
    body { background: #000; color: #0f0; font-family: 'VT323', monospace; margin:0; height:100vh; }
    .crt-monitor { width:100vw; height:100vh; background:#001100; box-shadow:inset 0 0 100px #000a; display:flex; flex-direction:column; justify-content:center; align-items:center; position:relative; }
    .center-content { display:flex; flex-direction:column; align-items:center; justify-content:center; flex:1; }
    .sudoku-board { display:grid; grid-template-columns: repeat(9, 40px); grid-template-rows: repeat(9, 40px); gap:2px; background:#111; border:3px solid #0f0; box-shadow:0 0 24px #0f0a; margin:40px 0 18px 0; }
    .cell { width:40px; height:40px; background:#222; border:1.5px solid #0f0; text-align:center; font-size:1.7rem; color:#0f0; outline:none; font-family:'VT323', monospace; transition:box-shadow 0.2s; }
    .cell:focus { box-shadow:0 0 8px #ffe14e; border-color:#ffe14e; background:#222; }
    .cell.prefilled { background:#003300; color:#39ff14; font-weight:bold; cursor:default; }
    .cell { box-sizing: border-box; }
    .cell:nth-child(9n+1), .cell:nth-child(9n+4), .cell:nth-child(9n+7) { border-left:3.5px solid #39ff14; }
    .cell:nth-child(-n+9) { border-top:3.5px solid #39ff14; }
    .cell:nth-child(n+19):nth-child(-n+27),
    .cell:nth-child(n+46):nth-child(-n+54),
    .cell:nth-child(n+73):nth-child(-n+81) { border-bottom:3.5px solid #39ff14; }
    .cell:nth-child(3), .cell:nth-child(6), .cell:nth-child(12), .cell:nth-child(15), .cell:nth-child(21), .cell:nth-child(24), .cell:nth-child(30), .cell:nth-child(33), .cell:nth-child(39), .cell:nth-child(42), .cell:nth-child(48), .cell:nth-child(51), .cell:nth-child(57), .cell:nth-child(60), .cell:nth-child(66), .cell:nth-child(69), .cell:nth-child(75), .cell:nth-child(78) { border-right:3.5px solid #39ff14; }
    .msg { color:#ffe14e; font-size:1.3rem; margin:10px 0 0 0; text-shadow:0 0 8px #ffe14e; }
    .btn { margin:18px 0 0 0; background:#111; color:#ffe14e; border:2px solid #ffe14e; font-family:'VT323', monospace; font-size:1.1rem; padding:7px 22px; border-radius:7px; cursor:pointer; transition:background 0.2s; }
    .btn:hover { background:#222; }
    .crt-monitor:after { content:''; pointer-events:none; position:absolute; left:0; top:0; width:100%; height:100%; background:repeating-linear-gradient(0deg,rgba(0,255,0,0.04),rgba(0,255,0,0.04) 2px,transparent 2px,transparent 4px); mix-blend-mode:screen; }
    .crt-side { position: fixed; top: 0; width: 140px; height: 100vh; z-index: 2; pointer-events: none; background: linear-gradient(180deg, rgba(0,255,0,0.08) 0%, rgba(0,255,0,0.13) 50%, rgba(0,255,0,0.08) 100%); box-shadow: 0 0 18px 2px #0f0a, 0 0 24px 0 #0f0a; opacity: 0.45; filter: blur(0.5px); overflow: hidden; transition: opacity 0.3s; animation: crt-glow 2.2s infinite alternate; }
    .crt-side-left { left: 0; border-right: 2px solid #0f0; }
    .crt-side-right { right: 0; border-left: 2px solid #0f0; }
    @media (max-width: 1100px) { .crt-side { display: none; } }
    @keyframes crt-glow { 0% { box-shadow: 0 0 8px 2px #0f0a, 0 0 16px 0 #0f0a; opacity: 0.35; } 100% { box-shadow: 0 0 24px 8px #0f0, 0 0 60px 0 #0f0a; opacity: 0.5; } }
  </style>
  <style>
      body { visibility: hidden; opacity: 0; transition: opacity 0.2s; }
      body.auth-ok { visibility: visible; opacity: 1; }
    </style>
  <script>
    (async function() {
      try {
        const res = await fetch('/api/login', { method: 'GET', credentials: 'include' });
        if (!res.ok) { window.location.href = 'index.html'; return; }
        const data = await res.json();
        if (!data.authenticated) {
          window.location.href = 'index.html';
        } else {
          document.body.classList.add('auth-ok');
        }
      } catch (e) {
        window.location.href = 'index.html';
      }
    })();
  </script>
</head>
<body>
  <div class="crt-side crt-side-left"></div>
  <div class="crt-side crt-side-right"></div>
  <div class="crt-monitor">
    <div class="center-content">
      <div class="sudoku-board" id="sudoku"></div>
      <div class="timer" id="timer"></div>
      <div class="msg" id="msg"></div>
    </div>
  </div>
  <script>
    // --- Generate Sudoku ---
    function generateSudoku() {
      function fill(grid, idx=0) {
        if(idx === 81) return true;
        let row = Math.floor(idx/9), col = idx%9;
        let nums = [1,2,3,4,5,6,7,8,9].sort(()=>Math.random()-0.5);
        for(let n of nums) {
          if(isSafe(grid, row, col, n)) {
            grid[idx] = n;
            if(fill(grid, idx+1)) return true;
            grid[idx] = 0;
          }
        }
        return false;
      }
      function isSafe(grid, row, col, n) {
        for(let i=0;i<9;i++) {
          if(grid[row*9+i]===n) return false;
          if(grid[i*9+col]===n) return false;
        }
        let br = Math.floor(row/3)*3, bc = Math.floor(col/3)*3;
        for(let r=0;r<3;r++) for(let c=0;c<3;c++) if(grid[(br+r)*9+bc+c]===n) return false;
        return true;
      }
      function countSolutions(grid, idx=0) {
        while(idx<81 && grid[idx]!==0) idx++;
        if(idx===81) return 1;
        let count=0;
        for(let n=1;n<=9;n++) {
          if(isSafe(grid, Math.floor(idx/9), idx%9, n)) {
            grid[idx]=n;
            count+=countSolutions(grid, idx+1);
            if(count>1) break;
            grid[idx]=0;
          }
        }
        grid[idx]=0;
        return count;
      }
      let solution = Array(81).fill(0);
      fill(solution);
      let mask = solution.slice();
      let positions = Array.from({length:81},(_,i)=>i).sort(()=>Math.random()-0.5);
      for(let pos of positions) {
        let backup = mask[pos];
        mask[pos]=0;
        let test = mask.slice();
        if(countSolutions(test)>1) mask[pos]=backup;
      }
      return {solution, mask};
    }
    let sudokuDiv = document.getElementById('sudoku');
    let msg = document.getElementById('msg');
    let currentSolution = [], currentMask = [];
    function renderSudoku() {
      sudokuDiv.innerHTML = '';
      const {solution, mask} = generateSudoku();
      currentSolution = solution;
      currentMask = mask;
      for(let i=0;i<81;i++) {
        let cell = document.createElement('input');
        cell.type = 'text';
        cell.maxLength = 1;
        cell.className = 'cell';
        cell.dataset.idx = i;
        if(mask[i] !== 0) {
          cell.value = mask[i];
          cell.disabled = true;
          cell.classList.add('prefilled');
        } else {
          cell.value = '';
        }
        sudokuDiv.appendChild(cell);
      }
      msg.textContent = '';
    }
    sudokuDiv.addEventListener('input', function(e) {
      const cell = e.target;
      let v = cell.value.replace(/[^1-9]/g,'');
      cell.value = v;
      checkSudoku();
    });
    function checkSudoku() {
      let ok = true;
      let full = true;
      for(let i=0;i<81;i++) {
        let cell = sudokuDiv.children[i];
        if(cell.disabled) continue;
        if(cell.value == '') full = false;
        if(cell.value == '' || parseInt(cell.value) !== currentSolution[i]) {
          ok = false;
        }
      }
      if(full) {
        if(ok) {
          msg.textContent = 'Access authorized.';
          // API call
          fetch('/api/progress', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ page: 'page4', solved: true })
          });
          setTimeout(()=>{ window.location.href = 'page4.html'; }, 1200);
        } else {
          msg.textContent = 'Invalid.';
        }
      } else {
        msg.textContent = '';
      }
    }
    // --- Timer ---
    let timerDiv = document.getElementById('timer');
    let totalSeconds = 600;
    function updateTimer() {
      let min = Math.floor(totalSeconds/60);
      let sec = totalSeconds%60;
      timerDiv.textContent = `Temps restant : ${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
      if(totalSeconds <= 0) {
        msg.textContent = 'Temps écoulé !';
        setTimeout(()=>{ window.location.href = 'page4.html'; }, 1200);
        clearInterval(timerInterval);
      }
    }
    updateTimer();
    let timerInterval = setInterval(()=>{
      totalSeconds--;
      updateTimer();
    },1000);
    renderSudoku();
  </script>
</body>
</html>
